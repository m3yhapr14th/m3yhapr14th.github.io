---
layout: post
title: Security Column 2022-05-14
subtitle: 침해사고 대응에 대한 이야기
gh-repo: m3yhapr14th/basic_edu
gh-badge: [star, fork, follow]
tags: [Security]
comments: true
---
![Cobalt Strike](/assets/img/Cobalt-Strike.jpg)

## 우연히 발견한 침해 사고

침해 사고를 방지하기 위한 가장 좋은 방법은 보안 관제 솔루션(SIEM)을 통해 실시간 관제와 이를 탐지할 수 있는 솔루션을 도입하는 것이다.그러나 이러한 업무도 사람이 하는 일이기 때문에 놓치는 경우도 있을 것이다.

가끔은 우연히 생각지도 못한 곳에서 침해 사고를 발견하기도 한다. 어느 날 오랜만에 IPS 를 들어가 로그탐방하던 중 사내에서 사용 중이지 않은 사설 IP가 스캐닝 공격을 한 듯한 로그를 발견했다. 그룹사의 IP 겠거니 다른 그룹사 담당자에 무슨 IP인가 물어보니 아니나 다를까 맞았다. 뭔가 싶어서 의심의 끈을 놓지 않았지만 별거 아니겠거니 그 날은 오탐 처리 후 종료하였다.

다음 날도 로그 탐방을 하던 중 다른 IP로 전 날과 비슷한 이벤트가 탐지되었길래 데이터를 봤더니 X-Forwarded-For 헤더에 전 날 봤던 IP가 있는게 아닌가. 탐지된 IP가 내부에서 사용 중인 서버였기에 접속해서 흔적을 찾기 시작했다. 히스토리를 보니 tmp 폴더에서 java 라는 이름으로 의심되는 IP를 연결해놓은 듯한 프로세스를 발견했고 전날 탐지되었던 그룹사 IP로 부터 실행된 녀석이었다.

아무리봐도 이상해서 그룹사 보안 담당자에 확인 요청을 했고 나는 우리 내부에 있는 서버를 좀 더 분석해보았다. 우리 회사에 대해 악의적인 생각을 가지고 했던 건 아닌 것 같았다. 히스토리를 남겨놓기도 했고 스크립트를 심어놓고 C2 통신만 열어놓은 상태였고 그 이후에 무언가를 시도하진 않았었다. C2 통신을 하는 IP는 러시아 IP였다..

```
**C2(=C&C): Command & Control
- 공격자가 악성코드를 제어하기 위한 컨트롤러 서버이며 내부 서버와 컨트롤러 서버와 연결시켜 놓는 것
```

침해 사고라 확신하여 우선 우리팀은 해당 그룹사 IP 대역과 단절시켜 초동 조치를 시작했고 업체에 분석을 요청하기 시작했다. 우리가 할 수 있는 부분은 업체에 C2 통신이 되었던 IP에 대한 방화벽 로그를 제공해주었고 감염된 서버들을 찾기 시작했다. 우리 팀도 방화벽에 남은 로그들을 가지고 통신 이력이 있는 서버들을 조사했다. 대체로 비슷한 이름(의심하지 못하도록 이름을 변경 ex. Java)으로 악성코드를 임시 폴더에 심어두거나 보안에 취약한 서버들은 시스템 폴더(system32)에 있기도 했다.

최초 발견한 서버에서는 SSH 로 연결된 흔적도 찾았는데 그 이후 발견된 곳에서도 동일한 계정으로 침입한 것을 확인했다. Cobalt Strike와 오픈 소스 웹스캐너를 통해 계정을 획득한 듯하다. 하필 서버 접근 제어 솔루션에서 사용하는 공통 계정이라 각 파트 별 인원이 동원되어 몇백개나 되는 서버의 패스워드를 전부 변경하는 작업을 하기도 했다. 

조치를 취하면 취할수록 공격자가 인지했는지 나중에 발견된 서버들의 이전 히스토리들을 지우고 있다는 것도 확인하였다. 가장 힘들었던 건 윈도우 서버들인데 이벤트 뷰어에서 필터를 걸어 보거나 하는 부분이 불편해서 꼼꼼하게 찾지 않으면 발견하기도 힘들었다.

몇날 며칠 밤을 지새워가며 업체에서 찾아주는 감염 서버들을 격리시키고 악성 코드 백업 및 삭제하며 언제 이 지옥이 끝날까하는데도 언제 이런 침해사고를 겪어보겠나하는 마음으로 버텨냈던 것 같다.

2주가 지나서야 끝날 기미가 보였다. 중간 조치도 마무리가 되면서 마지막으로 업체와 보고서를 리뷰하며 여태의 히스토리를 읽어가는데 정말 다행인 건 공격자도 악의적인 마음을 가지고 시작한게 아니라는 것이었다. 단순 호기심으로 시작된 스캐닝 후에 공격들이 먹히기 시작하니 멈출 수 없게 되었고 그게 침해 사고로 이어졌다는 것이었다. 그 이유는 전문성이 보이지 않았기 때문이 아니었을까? 개인 정보를 수집한 이력도 보이지 않았고 단순 침입과 악성코드를 심어놓는 것 외에 그 이상의 행위를 하지 않았기 때문인 것 같다.

이번 사고를 통해 느낀 점은 보안 솔루션을 많이 도입하고 매일 모니터링을 하더라도 언제든지 보안이 뚫릴 위험이 있다는 것과 우연히 생각지도 못한 곳에서 침해 사고와 마주할 수 있다는 것이다. 처음 겪는 일이다 보니 어떻게 대응할 것인지 어떤 조치를 해야하는지가 감이 잡히지 않았었는데 혼자 다 하려고 하기 보단 동료에게 내용을 공유하고 경험많은 상사에 보고하여 같이 대응해가면서 경험이 정말 중요하다고 느꼈다. 

### "매일 별 일 없이 반복 업무를 하는 인생에 안주하지 않고 항상 준비하고 의심하는 자세를 가지자"